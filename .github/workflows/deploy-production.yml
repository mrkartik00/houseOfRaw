name: Deploy House of Raw

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script_stop: true
          script: |
            set -e
            echo "ðŸš€ Deploying House of Raw..."
            
            cd /var/www/houseofraw
            git pull origin main
            
            # Backend
            echo "ðŸ“¦ Updating Backend..."
            cd /var/www/houseofraw/backend
            npm install --production
            pm2 restart houseofraw-api --update-env
            
            # Frontend
            echo "ðŸŽ¨ Building Frontend..."
            cd /var/www/houseofraw/frontend
            
            # Create .env.production with environment variables
            echo "VITE_BACKEND_URL=${{ secrets.VITE_BACKEND_URL }}" > .env.production
            echo "VITE_RAZORPAY_KEY_ID=${{ secrets.VITE_RAZORPAY_KEY_ID }}" >> .env.production
            echo "VITE_APP_NAME=House of Raw" >> .env.production
            
            npm install
            npm run build
            
            echo "âœ… Deployment Complete!"
            pm2 status