name: Deploy House of Raw

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.0
        continue-on-error: true
        id: deploy
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script_stop: false
          script: |
            set -e
            echo "üöÄ Deploying House of Raw..."
            
            cd ${{ secrets.DEPLOY_PATH }}
            git pull origin main
            
            # Backend
            echo "üì¶ Updating Backend..."
            cd backend
            npm install --production
            pm2 restart houseofraw-api --update-env
            
            # Frontend
            echo "üé® Building Frontend..."
            cd ../frontend
            
            # Create .env.production with environment variables
            echo "VITE_BACKEND_URL=${{ secrets.VITE_BACKEND_URL }}" > .env.production
            echo "VITE_RAZORPAY_KEY_ID=${{ secrets.VITE_RAZORPAY_KEY_ID }}" >> .env.production
            echo "VITE_APP_NAME=House of Raw" >> .env.production
            
            npm install
            npm run build
            
            echo "‚úÖ Deployment Complete!"
            pm2 status
      
      - name: Check Deployment Status
        if: steps.deploy.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è Deployment had issues but continuing..."
          echo "Check the logs above for details"